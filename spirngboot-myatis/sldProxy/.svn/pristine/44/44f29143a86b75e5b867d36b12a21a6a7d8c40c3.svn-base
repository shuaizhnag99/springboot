package com.ule.uhj.provider.yitu.service;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.util.HashMap;
import java.util.Map;

import org.apache.commons.lang3.StringUtils;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;

import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.ule.uhj.sldProxy.util.HttpClientUtil;

/**
* -
* @author 伍海涛
* @version 创建时间：2019年5月20日 下午2:15:20
* @retrun
*/
public class Tongji {
	public static PrintWriter pw = null;
    private static final String EXCEL_XLS = "xls";  
    private static final String EXCEL_XLSX = "xlsx";  
	
	public static void main(String[] args) {
//		String filePath ="D:\\test\\qianhaichadelv.txt";
//		qianhaiChaDelv(filePath);
		
		
		String finalXlsxPath ="D:/test/anhui/13030699899.xlsx";
		duxieExcel(finalXlsxPath);
	}
	
	
	
	//前海营业执照查得率
	public static void qianhaiChaDelv(String filePath){
		try {
			String sql = "SELECT I.USER_ONLY_ID,W.ORG_CODE,W.USER_NAME,W.STATUS," + 
					"       S.BUSINESS_LICENCE_NO," + 
					"       I.RESPONSE_INFO," + 
					"       I.CREATE_TIME" + 
					"  FROM T_J_INTERFACE_ACCESS_INFO I, T_J_CUSTOMER_STORE S, T_J_ZGD_WHITE W" + 
					" WHERE I.USER_ONLY_ID = S.USER_ONLY_ID(+)" + 
					"   AND I.USER_ONLY_ID = W.USER_ONLY_ID(+)" + 
					"   AND I.INTERFACE_TYPE = '9102'" + 
					"   AND I.CREATE_TIME > '2019-05-15'";
				
			String result1 = executeSearch(sql,"RESPONSE_INFO");
				
				JSONObject obj1 = (JSONObject)JSONObject.parse(result1);
				JSONArray arr1 =  (JSONArray)obj1.get("data");
				
				if(arr1 == null){
					return;
				}
				pw = new PrintWriter(new File(filePath));
				for(int i = 0; i < arr1.size() ;i++){
					JSONObject obj2 = (JSONObject)arr1.get(i);
					
					printField("USER_ONLY_ID", obj2, null);
					printField("ORG_CODE", obj2, null);
					printField("USER_NAME", obj2, null);
					printField("STATUS", obj2, null);
					printField("BUSINESS_LICENCE_NO", obj2, null);
					printField("RESPONSE_INFO", obj2, null);
					
					String businessLicenceNo =  obj2.getString("BUSINESS_LICENCE_NO");
					String responseInfo =  obj2.getString("RESPONSE_INFO");
					
					String value="";
					if(StringUtils.isNotBlank(businessLicenceNo)&& responseInfo.contains(businessLicenceNo)) {
						value="前海查得";
					}
					if(StringUtils.isNotBlank(businessLicenceNo)&& !responseInfo.contains(businessLicenceNo)) {
						value="前海未查得";
					}
					
					pw.print(value + "\t");
					printField("CREATE_TIME", obj2, null);
					
					pw.println();
					pw.flush();
				}
				pw.close();
		} catch (Exception e) {
			
		}
	}
	
	//读写excel例子
	 public static void duxieExcel(String finalXlsxPath) {
		 	String app_interface_url="http://soa.beta.uledns.com/sldProxy/interface/commontranz.do";
		 	
			System.out.println(finalXlsxPath);
			OutputStream out = null;  
	        try {  
	           
	            // 读取Excel文档  
	            File finalXlsxFile = new File(finalXlsxPath);  
	            Workbook workBook = getWorkbok(finalXlsxFile);  
	            System.out.println(" 001");
	            // sheet 对应一个工作页  
	            Sheet sheet = workBook.getSheetAt(0);  
	            /** 
	             * 往Excel中写新数据 
	             */  
	            Row row;
	            for (int i = 1; i <= sheet.getPhysicalNumberOfRows(); i++){
	            	row = sheet.getRow(i); 
		            if(row !=null){
		            	Cell storeInnercell =row.getCell(0);
		            	
		            	if(storeInnercell!=null){
		            		
		            		try {
			            		String storeInnerUrl = storeInnercell.getStringCellValue();
		                    	System.out.println(" storeInnerUrl:"+storeInnerUrl);	                    	
		                    	
//		                    	//人脸比对
		                    	Map<String, String> headers = new HashMap<String, String>();
		                		Map<String, Object> coparParams = new HashMap<String, Object>();//人脸比对参数
		                		coparParams.put("tranzCode", "3107");
		                		coparParams.put("appStoreinnerImgUrl", "D:/test/prdtu/anhui201710201803/storeinner"+storeInnerUrl+".jpg");
		                		coparParams.put("appSelffaceImgUrl", storeInnerUrl);
		                		coparParams.put("userOnlyId", "XXXXXXX");
		                		String rs =SampleCodeV3PairVerify.PairVerifyImgOrImg3(coparParams);
//		                		String	rs = HttpClientUtil.sendPost(app_interface_url, headers, coparParams, 30000);
		                		
		                		Double  score = new Double(88.88);
		                		row.createCell(9).setCellValue(score);
							} catch (Exception e) {
								e.printStackTrace();
							}
		            		
		            	}
		            }
	            	
	            }
	            // 创建文件输出流，准备输出电子表格：这个必须有，否则你在sheet上做的任何操作都不会有效  
	            out =  new FileOutputStream(finalXlsxPath);  
	            workBook.write(out);  
	        } catch (Exception e) {  
	            e.printStackTrace();  
	        } finally{  
	            try {  
	                if(out != null){  
	                    out.flush();  
	                    out.close();  
	                }  
	            } catch (IOException e) {  
	                e.printStackTrace();  
	            }  
	        }  
	        System.out.println("数据导出成功");  
	 }
	
	
	
	public static String executeSearch(String sql, String blobStr){
		Map<String,Object> dataMap = new HashMap<String, Object>();
		dataMap.put("executeSql", sql);
		dataMap.put("dataSourceType", "oracle");
		dataMap.put("blobString", blobStr);
		dataMap.put("clobString", null);
		
		String result = HttpClientUtil.httpPostJson("http://money.ule.com/ifadmin/executeController/search.do", dataMap);
		return result;
	}
	public static void printField(String key, JSONObject obj,Map map){
		String value = "";
		if(obj.getString(key) != null){
			value = obj.getString(key);
			if(map != null && map.keySet().size() > 0){
				value = (String)map.get(value);
			}
		}
		pw.print(value + "\t");
	}
	
    /** 
     * 判断Excel的版本,获取Workbook 
     * @param in 
     * @param filename 
     * @return 
     * @throws IOException 
     */  
    public static Workbook getWorkbok(File file) throws IOException{  
        Workbook wb = null;  
        FileInputStream in = new FileInputStream(file);  
        if(file.getName().endsWith(EXCEL_XLS)){  //Excel 2003  
            wb = new HSSFWorkbook(in);  
        }else if(file.getName().endsWith(EXCEL_XLSX)){  // Excel 2007/2010  
            wb = new XSSFWorkbook(in);  
        }  
        return wb;  
    } 
}
