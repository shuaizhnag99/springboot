package com.ule.uhj.sldProxy.sldBiz;

import java.io.IOException;
import java.net.URLEncoder;
import java.util.LinkedHashMap;
import java.util.Map;

import org.apache.commons.httpclient.HttpClient;
import org.apache.commons.httpclient.HttpException;
import org.apache.commons.httpclient.SimpleHttpConnectionManager;
import org.apache.commons.httpclient.methods.GetMethod;
import org.apache.commons.httpclient.params.HttpClientParams;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.alibaba.fastjson.JSONObject;
import com.ule.uhj.sld.biz.dto.Request;
import com.ule.uhj.sld.biz.dto.Response;
import com.ule.uhj.sld.biz.service.impl.DefaultSldService;
import com.ule.uhj.sld.model.SldOperateLog;
import com.ule.uhj.sld.util.Convert;
import com.ule.uhj.sldProxy.dao.SldOperateLogMapper;
import com.ule.uhj.sldProxy.service.InterfaceAccessInfoService;
import com.ule.uhj.sldProxy.util.PropertiesHelper;

/**
 * 百度接口-内部对接服务
 */
@Component(value="BDSldService")
public class BDSldService  extends DefaultSldService {
    @Autowired
    SldOperateLogMapper sldOperateLogMapper;
    @Autowired
	private InterfaceAccessInfoService interfaceAccessInfoService;
    /***
     * 百度查询成功
     */
    public static  final String SUCCESS = "000000";

    /***
     * 经纬度未传入时的错误代码
     */
    public  static final String PARAMS_ERROR = "000001";
    /***
     * 百度查询失败
     */
    public static final String QUERY_ERROR = "900001";

	@Override
    public Response doService(Request request){
        log.info("百度查询：开始，request="+request.toString());
        //返回结果
        Response response = new Response();
        //传入参数
        Map<String,Object> dataMap = request.getDataMap();
        
        GetMethod method = null;
        String location = Convert.toStr(dataMap.get("location"));
        String query = Convert.toStr(dataMap.get("query"));
        String radius = Convert.toStr(dataMap.get("radius"));
        if(StringUtils.isBlank(location)&&StringUtils.isBlank(query)&&StringUtils.isBlank(radius)){
        	log.info("百度查询：经纬度、关键字或查询范围为空！无法查询！");
            response.setResponseCode(PARAMS_ERROR);
            response.setMessage("百度查询：经纬度、关键字或查询范围为空！无法查询！");
            return response;
        }
        try{
            Map<String, Object> paramsMap = new LinkedHashMap<String, Object>();
    		paramsMap.put("query", URLEncoder.encode(query));
    		paramsMap.put("radius", radius);
    		paramsMap.put("output", "json");
    		paramsMap.put("page_size", 1);
    		paramsMap.put("page_num", 1);
    		paramsMap.put("ak", PropertiesHelper.getDfs("BAIDU_AK"));
    		paramsMap.put("location", location);
    			
    		String url = this.getUrlByHttpGet(paramsMap);
    		if(url!=null){
    			String responseStr = null;
    			HttpClientParams httpParams = new HttpClientParams();
    			httpParams.setContentCharset("UTF-8");
    			HttpClient client = new HttpClient(httpParams,new SimpleHttpConnectionManager(true));
    			method = new GetMethod(url.toString());
    			client.executeMethod(method);
    			int accessStatus = method.getStatusCode();
    			responseStr = method.getResponseBodyAsString();       
    			if(accessStatus == 200){
    				Map<String, Object> object = (Map<String, Object>)JSONObject.parse(responseStr);
    				if((Integer)object.get("status")==0){
    					response.setResponseCode(SUCCESS);
    		            response.setMessage("百度接口查询成功");
    					response.setResponseMap(object);
    				}else{
    					throw new Exception("百度接口访问失败");
    				}
    			}else{
    				throw new Exception("百度接口访问失败");
    			}
    			saveOperateLog(request);
    		}
        }catch (HttpException e) {
			log.error("baidu interface access HttpException error", e);
			response.setResponseCode(QUERY_ERROR);
            response.setMessage("百度店铺周边信息查询失败！调用百度API时发生异常："+e);
			e.printStackTrace();  
		}catch (IOException e) {  
			log.error("queryTotalCountOfBaiduPlaceByKeyWordList IOException error", e);
			response.setResponseCode(QUERY_ERROR);
            response.setMessage("百度店铺周边信息查询失败！调用百度API时发生异常："+e);
			e.printStackTrace();  
		}catch (Exception e){
            log.error("百度：发起查询失败！", e);
            response.setResponseCode(QUERY_ERROR);
            response.setMessage("百度店铺周边信息查询失败！调用百度API时发生异常："+e);
        }finally{
            if(method!=null){
            	method.releaseConnection(); 
            } 	
        }
        
        interfaceAccessInfoService.saveInterfaceRecord(JSONObject.toJSONString(request), JSONObject.toJSONString(response),request.getUserOnlyId(),request.getTransCode(),"300");
        return response;
    }
	
	private void saveOperateLog(Request request){
        log.info("BRSldService类updateTransBrInfo方法 ：开始。");
        try{
            SldOperateLog sldOperateLog = request.getOpeartor();
            sldOperateLog.setOperationContent("调用百度接口"+request.getTransCode());
            sldOperateLogMapper.insert(sldOperateLog);
            log.info("BDSldService类saveOperateLog方法：插入操作记录成功！");
        }catch (Exception e){
            log.error("BDSldService类saveOperateLog方法：插入操作记录时异常！"+e.getMessage(),e);
        }
    }
	
	/**
	 * 访问百度接口，查询地址经纬度周边信息
	 * @param paramsMap
	 * @return
	 */
	private String getUrlByHttpGet(Map<String, Object> paramsMap) {
		StringBuffer url = new StringBuffer(PropertiesHelper.getDfs("BAIDU_INTERFACE_URL"));
		StringBuffer params = new StringBuffer("?");
		for(String key:paramsMap.keySet()){
			if(!"URL".equals(key)){
				params.append(key).append("=").append(paramsMap.get(key).toString()).append("&");
			}
		}
		url.append(params.toString());
		return url.substring(0, url.length()-1);
	}
}
